# 1 Care and feeding of iptables

This chapter covering essential aspects of properly installing, maintaining, and interacting with the iptables firewall on Linux systems. Also , aspects such as iptables administration from the perspectives of both kernel and userland, as well as how to build and maintain an iptables firewall policy. 

## 1.1 iptables

The iptables firewall is developed by Netfilter Project and has been available to the masses as part of Linux since the release of the Linux 2.4 kernel in January 2001.

The differences between the terms *iptables* and *Netfilter* have been a source of some confusion in the Linux community. To reduce the complexity, think them as follow:

 - Netfilter: providing the framework on which *iptables* builds firewall functionality.
 - iptables: refers to the userland tool that parses the command line and communicates a firewall policy to the kernel.

Terms such as *tables* , *chains* , *matches* , and *targets* make sense in the context of iptables.

Netfilter does not filter traffic itself--it just allows functions that *can* filter traffic to be hooked into the right spot within the kernel. The Netfilter Project also provides serveral pieces of infrastructure in the kernel, such as connection tracking and logging; any iptables policy can use these facilities to perform specialized packet processing.

## 1.2 Packet Filtering with iptables

An iptables policy is built from an ordered set of *rules* , which describe to the kernel the actions that should be taken against certain classes of packets. Each iptables rule is applied to a chain within a table.  **An iptables *chain* is a collection of rules that are compared , in order , against packets that share a common characteristic (such as being routed to the Linux system, as opposed to away from it.)**

### 1.2.1 Tables

A *table* is an iptables construct that delineates broad categories of functionality, such as packet filtering or Network Address Translation(NAT). There are four tables: **filter** , **nat** , **mangle** , and **raw** .

Filtering rules are applied to the filter table.

NAT rules are applied to the nat table.

Specialized rules that alter packet data are applied to the mangle table.

Rules that should function independently of the Netfilter connection-tracking subsystem are applied to the raw table.

### 1.2.2 Chains

Each table has its own set of built-in chains, but user-defined chains can also be created so that the user can build a set of rules that is related by a common tag such as **INPUT_ESTABLISHED** or **DMZ_NETWORK** . The most important built-in chains for our purposes are the **INPUT** , **OUTPUT** , and **FORWARD** chains in the filter table:

- The **INPUT** chain is traversed by packets that are **destined for the local Linux system after a routing calculation is made within the kernel(i.e., packets destined for a local socket)**.
- The **OUTPUT** chain is reserved for packets that are **generated by the Linux system itself**.
- The **FORWARD** chain governs packets that are **routed through the Linux system(i.e., when the iptables firewall is used to connect one network to another and packets between the two networks must flow through the firewall)**.

Two additional chains that are important for any serious iptables deployment are the **PREROUTING** and **POSTROUTING** chains in the nat table, which are **used to modify packet headers before and after an IP routing calculation is made within the kernel**.

Figure 1-1 shows how packets flow through the **nat** and **filter** tables within the kernel.

![packets_flow](/home/tux/Documents/firewall_notes/Linux_firewalls/chap01/packets_flow.png)

### 1.2.3 Matches

Every iptables rule has a set of matches along with a *target* that tells iptables what to do with a packet that conforms to the rule. **An iptables *match* is a condition that must be met by a packet in order for iptables to process the packet according to the action specified by the rule target**. 

Each match is specified on the iptables command line. The most import iptables matches for this book are listed below:

**--source (-s)** 					Match on a source IP address or network

**--destination (-d)**			Match on a destination IP address or network

**--protocol (-p)** 				

**--in-interface (-i)** 	Input interface

**--out-interface (-o)** 	Output interface

**--state** 				Match on a set of connection states

**--string** 				Match on a sequence of application layer data bytes

**--comment** 			Associate up to 256 bytes of comment data with a rule within kernel memory

### 1.2.4 Targets

Iptables supports a set of targets that trigger an action when a packet matches a rule. The most import targets used in this book are as follows:

**ACCEPT**			Allows a packet to continue on its way.

**DROP**			Drops a packet. No further processing is performed, and as far as the receiving 

​				stack is concerned, it is as though the packet was never sent.

**LOG**			Logs a packet to syslog

**REJECT**			Drops a packet and simultaneously sends an appropriate response packet (e.g., a

​				TCP Reset packet for a TCP connection or an ICMP Port Unreachable message for 

​				a UDP packet).

**RETURN**		Continues processing a packet within the calling chain.

## 1.3 Installing iptables

Because iptables is split into two fundamental components (kernel modules and the userland administration program), installing iptables involves compiling and installing both the Linux kernel and the userland binary.

Linux内核源码包含了Netfilter的许多子系统，基本的包过滤功能在一些内核发行版本中是默认开启的。

在内核2.6早期版本以及2.4版中，Netfilter编译选项默认是没有开启的。

虽然许多Linux发行版自带了编译好的iptables， 但从Linux内核官网下载的内核设置默认是没有开启的，所以并不是所有的Netfilter子系统都开启了。例如Netfilter connection-tracking功能直到内核的2.6.20.1版才默认开启。



